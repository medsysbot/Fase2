<!DOCTYPE html>
<html lang="es">
<head>
<!-- ╔════════════════════════════════════╗ -->
<!-- ║      CABECERA DEL FORMULARIO      ║ -->
<!-- ╚════════════════════════════════════╝ -->
  <meta charset="UTF-8">
  <title>Estudios Médicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <img src="/static/icons/estudios.png" alt="Estudios Médicos" class="logo-grande">
    <h2>Estudios Médicos</h2>
  </header>

  <!-- ╔════════════════════════════════════╗ -->
  <!-- ║        DATOS DEL PACIENTE        ║ -->
  <!-- ╚════════════════════════════════════╝ -->
  <form id="form-estudio" autocomplete="off">
    <label>Nombre:</label>
    <input type="text" id="nombre" name="nombre" />
    <label>Apellido:</label>
    <input type="text" id="apellido" name="apellido" />

    <label>DNI del Paciente:</label>
    <input type="number" id="paciente_id" name="paciente_id" required />

    <label>Tipo de Estudio:</label>
    <select id="tipo_estudio" name="tipo_estudio" required>
      <option value="">Seleccionar…</option>
      <option value="Radiografia de Torax">Radiografía de Tórax</option>
      <option value="Tomografia TAC">Tomografía (TAC)</option>
      <option value="Resonancia Magnetica">Resonancia Magnética (RMN)</option>
      <option value="Electrocardiograma">Electrocardiograma (ECG)</option>
      <option value="Ecografia Abdominal">Ecografía Abdominal</option>
      <option value="Ecografia Transvaginal">Ecografía Transvaginal</option>
      <option value="Mamografia">Mamografía</option>
      <option value="Analisis de Sangre">Análisis de Sangre</option>
      <option value="Analisis de Orina">Análisis de Orina</option>
      <option value="Colonoscopia">Colonoscopía</option>
      <option value="Endoscopia">Endoscopía</option>
      <option value="Espirometria">Espirometría</option>
      <option value="Audiometria">Audiometría</option>
      <option value="TAC de craneo">TAC de cráneo</option>
      <option value="RMN de columna">RMN de columna</option>
      <option value="Densitometria">Densitometría</option>
      <option value="Otros">Otros…</option>
    </select>
    <!-- Lista de fechas de estudios (se muestra tras buscar) -->
    <ul id="lista-fechas" class="lista-fechas" style="display:none;"></ul>
    <input type="hidden" id="pdf_url" name="pdf_url" />
  </form>

  <div id="visorContainer" style="width:100%; height:600px; overflow:auto; display:none;">
    <!-- ╔════════════════════════════════════╗ -->
    <!-- ║             VISOR DE PDF         ║ -->
    <!-- ╚════════════════════════════════════╝ -->
    <iframe id="visorPDF" width="100%" height="100%" frameborder="0"></iframe>
    <button id="btnVerPDF" class="abrir-nueva-pestania" style="display:none; margin-top:8px;">
      Ver PDF
    </button>
  </div>

  <div class="botones-flotantes">
    <button type="button" ondblclick="marcarCamposVoz()" title="Reconocimiento por voz">
      <img src="/static/icons/microfono.png" alt="Voz" />
    </button>
    <button type="button" onclick="enviarPorCorreo()" title="Enviar por Email">
      <img src="/static/icons/enviar.png" alt="Enviar por Email" />
    </button>
    <button id="btnBuscar" type="button" onclick="buscarEstudio()" title="Buscar">
      <img src="/static/icons/busquedas.png" alt="Buscar" width="24" />
    </button>
    <button type="button" id="btn-guardar" onclick="guardarEstudio()" title="Guardar" style="display:none;">
      <img src="/static/icons/guardar.png" alt="Guardar" />
    </button>
  </div>

  <!-- ALERT MANAGER -->
  <div id="alert-manager" class="alert-container" style="display:none;">
    <div class="alert-box">
      <img id="alert-icon" src="" alt="icono-alerta" class="alert-icon" />
      <span id="alert-text" class="alert-message">Texto de alerta</span>
      <div id="alert-buttons" class="alert-buttons" style="display:none;">
        <img src="/static/icons/alerta/alerta-boton-borrar.png" id="btn-borrar" class="alert-btn" />
        <img src="/static/icons/alerta/alerta-boton-no.png" id="btn-no" class="alert-btn" />
      </div>
    </div>
  </div>

  <script src="/static/js/alertas.js"></script>
  <script src="/static/js/estudios_medicos.js"></script>
  <script src="/static/js/registro_voz.js"></script>
  <script>
    // Adaptación: flujo para lista de fechas, visor PDF y botón "Ver PDF"
    // No toca nada del CSS ni estructura original.
    let listaFechas = document.getElementById('lista-fechas');
    let visorContainer = document.getElementById('visorContainer');
    let visorPDF = document.getElementById('visorPDF');
    let btnVerPDF = document.getElementById('btnVerPDF');
    let pdfActual = "";

    // Esta función debe ser llamada después de buscar (buscarEstudio)
    function mostrarFechasEstudios(fechas) {
      listaFechas.innerHTML = '';
      if (fechas.length > 0) {
        listaFechas.style.display = 'block';
        fechas.forEach((est) => {
          let li = document.createElement('li');
          let btn = document.createElement('button');
          btn.type = "button";
          btn.className = "fecha-link";
          btn.innerHTML = `${est.fecha} — ${est.descripcion || est.tipo_estudio}`;
          btn.onclick = function () {
            document.querySelectorAll('.fecha-link').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            visorPDF.src = est.pdf_url;
            visorContainer.style.display = "block";
            pdfActual = est.pdf_url;
            btnVerPDF.style.display = "inline-block";
            btnVerPDF.onclick = () => window.open(est.pdf_url, '_blank');
            showAlert({
              mensaje: "Mostrando estudio seleccionado.",
              tipo: "success"
            });
          };
          li.appendChild(btn);
          listaFechas.appendChild(li);
        });
      } else {
        listaFechas.style.display = 'none';
        visorContainer.style.display = 'none';
        btnVerPDF.style.display = 'none';
        visorPDF.src = "";
        showAlert({
          mensaje: "No hay estudios registrados para ese filtro.",
          tipo: "info"
        });
      }
    }
    // Podés llamar mostrarFechasEstudios(array) desde tu función buscarEstudio().
  </script>
</body>
</html>
